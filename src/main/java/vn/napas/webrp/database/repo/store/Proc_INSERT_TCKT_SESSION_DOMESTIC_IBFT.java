package vn.napas.webrp.database.repo.store;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import vn.napas.webrp.report.util.SqlLogUtils;

import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

/**
 * TiDB runnable repo converted from RPT.INSERT_TCKT_SESSION_DOMESTIC_IBFT
 * (Oracle).
 *
 * NOTE: - Các bước dọn dẹp/backup/cleanup và xóa phiên cũ đã chuyển sang TiDB
 * 100%. - Các block INSERT/UPDATE dài (ISS-ACQ, ACQ-ISS, ISS-BEN, BEN-ISS; và
 * các block ADJUST) trong store gốc sử dụng rất nhiều cú pháp Oracle (đặc biệt
 * DECODE ~150 lần). Phần này cần chuyển thành CASE ... WHEN ... THEN ... END
 * cho TiDB. - Trong bản đầu tiên này, mình đã đặt placeholder rõ ràng cho từng
 * step + giữ NGUYÊN comment của store, để bạn kiểm soát. Khi dán thêm bản CASE
 * hóa hoàn chỉnh, chỉ cần thay nội dung chuỗi SQL tương ứng.
 */
@Slf4j
@Repository
@RequiredArgsConstructor
public class Proc_INSERT_TCKT_SESSION_DOMESTIC_IBFT {

	private final NamedParameterJdbcTemplate jdbc;
	private final String bankcardid = "605608";

	// ==========================
	// Phần đã convert sang TiDB
	// ==========================

	// --xoa du lieu backup > 15 ngay
	private static final String SQL_CLEANUP_BACKUP_OLD = """
			    DELETE FROM TCKT_SESSION_DOMESTIC_AUTO_BKUP
			    WHERE INSERT_DATE < DATE_SUB(CURDATE(), INTERVAL 15 DAY)
			""";

	// --backup du lieu truoc khi xoa
	private static final String SQL_BACKUP_SESSION = """
			INSERT INTO TCKT_SESSION_DOMESTIC_AUTO_BKUP (
			    INSERT_DATE, ADJ_FEE, BANK_ID, BANK_NAME, BC_CL_ADJ, BC_NP_ADJ, BC_NP_SUM,
			    CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY, CD_TOTAL_TRAN, CORR_BANK_ID,
			    CREDIT, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE, DB_TOTAL_FEE, DB_TOTAL_MONEY, DB_TOTAL_TRAN,
			    DEBIT, EDIT_DATE, FEE_TYPE, GROUP_ROLE, GROUP_TRAN, IS_FEE, LIQUIDITY, MERCHANT_TYPE,
			    MSGTYPE_DETAIL, NAPAS_FEE, NP_ADJ_FEE, OD_BY, PART_FE, PCODE, RESPCODE, SERVICE_CODE,
			    SERVICE_TYPE, SETTLEMENT_CURRENCY, SETT_DATE, STEP, SUB_BANK, TRAN_TYPE, WITH_BANK
			)
			SELECT NOW(), ADJ_FEE, BANK_ID, BANK_NAME, BC_CL_ADJ, BC_NP_ADJ, BC_NP_SUM,
			       CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY, CD_TOTAL_TRAN, CORR_BANK_ID,
			       CREDIT, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE, DB_TOTAL_FEE, DB_TOTAL_MONEY, DB_TOTAL_TRAN,
			       DEBIT, EDIT_DATE, FEE_TYPE, GROUP_ROLE, GROUP_TRAN, IS_FEE, LIQUIDITY, MERCHANT_TYPE,
			       MSGTYPE_DETAIL, NAPAS_FEE, NP_ADJ_FEE, OD_BY, PART_FE, PCODE, RESPCODE, SERVICE_CODE,
			       SERVICE_TYPE, SETTLEMENT_CURRENCY, SETT_DATE, STEP, SUB_BANK, TRAN_TYPE, WITH_BANK
			FROM TCKT_SESSION_DOMESTIC
			WHERE (DATE(INSERT_DATE) <= DATE(:sLastSettDate) OR INSERT_DATE > DATE(NOW()))
			  AND SERVICE_TYPE = 'IBFT';

						""";

	// --xoa du lieu TCKT_SESSION_DOMESTIC cua phien cu
	private static final String SQL_DELETE_OLD_SESSION = """
			    DELETE FROM TCKT_SESSION_DOMESTIC
			    WHERE (DATE(INSERT_DATE) <= DATE(:sLastSettDate) OR INSERT_DATE > DATE(NOW()))
			      AND SERVICE_TYPE = 'IBFT'
			""";

	// =============================================================
	// PHẦN CẦN THAY THẾ = BẢN SQL TIDB THUẦN (đã giữ nguyên comment)
	// =============================================================

	// -- Begin: Xu ly tong hop du lieu GD thanh cong tu bang SHCLOG_SETT_IBFT

	// -- step 1 -- ISS-ACQ
	private static final String SQL_STEP_1_ISS_ACQ = """
						-- step 1
						-- ISS-ACQ (TiDB)
			/* step 1 — ISS-ACQ (TiDB/MySQL) */
			INSERT INTO TCKT_SESSION_DOMESTIC(
			  INSERT_DATE, MSGTYPE_DETAIL, SUB_BANK, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE,
			  GROUP_TRAN, PCODE, TRAN_TYPE, SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK,
			  DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE, DB_TOTAL_FEE, DB_TOTAL_MONEY,
			  CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, BC_NP_SUM, BC_CL_ADJ, STEP, FEE_TYPE, PART_FE, SERVICE_TYPE
			)
			SELECT
			  NOW() AS INSERT_DATE,
			  MSGTYPE_DETAIL,
			  CASE WHEN ISSUER_RP = 970426 AND SUBSTRING(TRIM(PAN),1,8) = '97046416' THEN 970464 ELSE NULL END AS SUB_BANK,

			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > STR_TO_DATE(:sett_to,'%d/%m/%Y')   THEN STR_TO_DATE(:sett_to,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y')
			         THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(Edit_Date) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			           ELSE DATE(Edit_Date)
			         END
			  END AS EDIT_DATE,

			  /* SETTLEMENT_CURRENCY */
			  CASE WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			       WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			       ELSE 704 END AS SETTLEMENT_CURRENCY,

			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','42','48','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,

			  /* PCODE chuẩn 2 ký tự + PCODE2 (vài case) */
			  CASE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			         THEN CONCAT(LPAD(CAST(PCODE AS CHAR),2,'0'), PCODE2)
			    ELSE LPAD(CAST(PCODE AS CHAR),2,'0')
			  END AS PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,977900,987900,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,

			  'SWITCH' AS SERVICE_CODE,
			  'ISS-ACQ' AS GROUP_ROLE,
			  ISSUER_RP AS BANK_ID,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ACQUIRER_RP ELSE BB_BIN END AS CORR_BANK_ID,

			  /* WITH_BANK — CHÚ Ý: dùng ACQUIRER_RP và :bccard_id, và GROUP BY phải giống hệt */
			  CASE
			    WHEN ACQUIRER_RP IN (220699, 602907, 605609, :bccard_id) THEN ACQUIRER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END AS WITH_BANK,

			  /* SUMs */
			  SUM(CASE WHEN Pcode IN ('42','91') THEN 0 ELSE 1 END) AS DB_TOTAL_TRAN,

			  SUM(
			    CASE
			      WHEN Pcode IN ('00','01','40','20') THEN
			        CASE
			          WHEN PCODE = '20' AND Respcode IN (112,114) THEN -IFNULL(PREAMOUNT,0)
			          WHEN PCODE = '20' THEN -AMOUNT
			          WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS DB_AMOUNT,

			  SUM(CASE WHEN FEE_IRF_ISS < 0 THEN -FEE_IRF_ISS ELSE 0 END) AS DB_IR_FEE,
			  -SUM(CASE WHEN Pcode IN ('42','91') THEN 0 ELSE FEE_SVF_ISS END) AS DB_SV_FEE,

			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,
			  0 AS CD_TOTAL_TRAN,

			  SUM(
			    CASE
			      WHEN Pcode = '40' THEN
			        CASE
			          WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS CD_AMOUNT,

			  SUM(CASE WHEN FEE_IRF_ISS > 0 AND IFNULL(Pcode2,0) NOT IN (890000,720000) THEN FEE_IRF_ISS ELSE 0 END) AS CD_IR_FEE,
			  SUM(CASE WHEN FEE_SVF_ISS < 0 THEN 0 ELSE FEE_SVF_ISS END) AS CD_SV_FEE,

			  SUM(
			    CASE
			      WHEN Pcode = '40' THEN
			        CASE
			          WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS CD_TOTAL_MONEY,

			  0 AS NAPAS_FEE,

			  SUM(
			    CASE
			      WHEN Acquirer = 220699 AND Merchant_Type = 6011 AND Pcode IN ('01','30') THEN FEE_IRF_ACQ
			      WHEN ISSUER   = 220699 AND Merchant_Type = 6011 AND Pcode IN ('01','30') THEN FEE_IRF_ACQ
			      ELSE 0
			    END
			  ) AS ADJ_FEE,

			  0 AS NP_ADJ_FEE,

			  /* MERCHANT_TYPE (đúng theo nhánh Oracle) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND Merchant_type_orig IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,

			  /* BC_NP_SUM & BC_CL_ADJ */
			  SUM(
			    CASE
			      WHEN Issuer_Rp = 600005 AND Merchant_Type = 6011 THEN FEE_IRF_ISS
			      WHEN Issuer_Rp = 600005 AND Merchant_Type = 6012 THEN FEE_IRF_ISS
			      WHEN Issuer_Rp = 600006 AND Merchant_Type = 6012 THEN FEE_IRF_ISS
			      WHEN Issuer_Rp = 600007 THEN FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS BC_NP_SUM,

			  SUM(CASE WHEN Issuer_Rp IN (600005,600007) THEN FEE_IRF_ISS ELSE 0 END) AS BC_CL_ADJ,

			  'A-BY_ROLE' AS STEP,

			  /* FEE_TYPE */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,

			  /* PART_FE */
			  CASE
			    WHEN Msgtype = 430 AND Respcode = 114 THEN 1
			    WHEN Msgtype = 210 AND Respcode IN (112,114) AND Is_part_rev = 430 THEN 1
			    ELSE 0
			  END AS PART_FE,

			  'IBFT' AS SERVICE_TYPE

			FROM SHCLOG_SETT_IBFT
			WHERE (
			        (Respcode = 0 AND Isrev IS NULL)
			        OR Respcode IN (110,112,113,114,115)
			      )
			  AND Fee_Note IS NOT NULL
			  AND (
			        (PCODE2 IS NULL    AND Pcode IN ('00','01','30','35','40','41','42','43','48','94','03','20'))
			        OR
			        (PCODE2 IS NOT NULL AND Pcode IN ('00','01','30','35','40','41','42','43','48','94','91','03','20'))
			      )

			/* === GROUP BY: phải khớp y hệt các biểu thức không-aggregate ở SELECT === */
			GROUP BY
			  MSGTYPE_DETAIL,
			  CASE WHEN ISSUER_RP = 970426 AND SUBSTRING(TRIM(PAN),1,8) = '97046416' THEN 970464 ELSE NULL END,
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < STR_TO_DATE(:fromDate,'%d/%m/%Y') THEN STR_TO_DATE(:fromDate,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > STR_TO_DATE(:toDate,'%d/%m/%Y')   THEN STR_TO_DATE(:toDate,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:fromDate,'%d/%m/%Y') AND STR_TO_DATE(:toDate,'%d/%m/%Y')
			         THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(Edit_Date) < STR_TO_DATE(:fromDate,'%d/%m/%Y') THEN STR_TO_DATE(:fromDate,'%d/%m/%Y')
			           ELSE DATE(Edit_Date)
			         END
			  END,
			  CASE WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			       WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			       ELSE 704 END,
			  RESPCODE,
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','42','48','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,
			  CASE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			         THEN CONCAT(LPAD(CAST(PCODE AS CHAR),2,'0'), PCODE2)
			    ELSE LPAD(CAST(PCODE AS CHAR),2,'0')
			  END,
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,977900,987900,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,
			  ISSUER_RP,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ACQUIRER_RP ELSE BB_BIN END,
			  CASE
			    WHEN ACQUIRER_RP IN (220699, 602907, 605609, :bccard_id) THEN ACQUIRER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END,
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND Merchant_type_orig IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END,
			  CASE
			    WHEN Msgtype = 430 AND Respcode = 114 THEN 1
			    WHEN Msgtype = 210 AND Respcode IN (112,114) AND Is_part_rev = 430 THEN 1
			    ELSE 0
			  END;
			""";

	// -- step 2 -- ACQ-ISS
	private static final String SQL_STEP_2_ACQ_ISS = """
									-- step 2
									-- ACQ-ISS (TiDB)
									-- step 2 -- ACQ-ISS (TiDB)
			/* STEP 2 — ACQ-ISS (TiDB), giữ nguyên logic gốc */
			INSERT INTO TCKT_SESSION_DOMESTIC(
			  INSERT_DATE, MSGTYPE_DETAIL, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE,
			  GROUP_TRAN, PCODE, TRAN_TYPE, SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK,
			  DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE, DB_TOTAL_FEE, DB_TOTAL_MONEY,
			  CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, BC_NP_ADJ, BC_NP_SUM, STEP, FEE_TYPE, PART_FE, SERVICE_TYPE
			)
			SELECT
			  NOW() AS INSERT_DATE,
			  MSGTYPE_DETAIL,
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > STR_TO_DATE(:sett_to,'%d/%m/%Y')   THEN STR_TO_DATE(:sett_to,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y') THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE WHEN DATE(Edit_Date) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y') ELSE DATE(Edit_Date) END
			  END AS EDIT_DATE,
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END AS SETTLEMENT_CURRENCY,
			  RESPCODE,
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,
			  CASE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			      THEN CONCAT(SUBSTRING(LPAD(CAST(PCODE AS CHAR),2,'0'),1,2), PCODE2)
			    ELSE SUBSTRING(LPAD(CAST(PCODE AS CHAR),2,'0'),1,2)
			  END AS PCODE,
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,979500,988500,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,
			  'SWITCH'  AS SERVICE_CODE,
			  'ACQ-ISS' AS GROUP_ROLE,
			  ACQUIRER_RP AS BANK_ID,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ISSUER_RP ELSE BB_BIN END AS CORR_BANK_ID,
			  CASE
			    WHEN ISSUER_RP IN (220699,602907,605609,:bccard_id,600005,600006,600007) THEN ISSUER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END AS WITH_BANK,
			  0 AS DB_TOTAL_TRAN,
			  0 AS DB_AMOUNT,
			  SUM(
			    CASE
			      WHEN ACQUIRER_RP = :bccard_id AND FEE_IRF_ISS > 0 THEN FEE_IRF_ISS
			      WHEN FEE_IRF_ACQ < 0 THEN -FEE_IRF_ACQ
			      ELSE 0
			    END
			  ) AS DB_IR_FEE,
			  0 AS DB_SV_FEE,
			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,
			  SUM(CASE WHEN Pcode IN ('41','42','43','48','91') THEN 0 ELSE 1 END) AS CD_TOTAL_TRAN,
			  SUM(
			    CASE
			      WHEN Pcode IN ('00','01','20') THEN
			        CASE
			          WHEN PCODE = '20' AND Respcode IN (112,114) THEN CASE WHEN PREAMOUNT IS NULL THEN 0 ELSE -PREAMOUNT END
			          WHEN PCODE = '20' THEN -AMOUNT
			          WHEN Respcode IN (112,114) THEN CASE WHEN PREAMOUNT IS NULL THEN 0 ELSE PREAMOUNT END
			          ELSE CASE WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS CD_AMOUNT,
			  SUM(
			    CASE
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type = 6011 THEN -FEE_IRF_ISS
			      WHEN FEE_IRF_ACQ > 0 AND ACQUIRER_RP = :bccard_id AND MERCHANT_TYPE <> 6011 THEN FEE_IRF_ACQ
			      WHEN FEE_IRF_ACQ > 0 AND ACQUIRER_RP = :bccard_id AND MERCHANT_TYPE = 6011 THEN 0
			      WHEN FEE_IRF_ACQ > 0 THEN FEE_IRF_ACQ
			      ELSE 0
			    END
			  ) AS CD_IR_FEE,
			  -SUM(FEE_SVF_ACQ) AS CD_SV_FEE,
			  0 AS CD_TOTAL_MONEY,
			  0 AS NAPAS_FEE,
			  0 AS ADJ_FEE,
			  SUM(CASE WHEN FEE_KEY = 'CFC85B5F-787B-437C-823F-79534D3B72BD' THEN FEE_IRF_ACQ ELSE 0 END) AS NP_ADJ_FEE,
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND Merchant_type_orig IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,
			  -SUM(
			    CASE
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type = 6011 THEN FEE_IRF_ISS
			      WHEN ACQUIRER_RP = :bccard_id AND FEE_IRF_ISS > 0 AND Merchant_Type <> 6011 THEN FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS BC_NP_ADJ,
			  SUM(
			    CASE
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type = 6011 THEN -FEE_IRF_ISS
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type <> 6011 THEN -FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS BC_NP_SUM,
			  'A-BY_ROLE' AS STEP,
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,
			  CASE
			    WHEN Msgtype = 430 AND Respcode = 114 THEN 1
			    WHEN Msgtype = 210 AND Respcode IN (112,114) AND Is_part_rev = 430 THEN 1
			    ELSE 0
			  END AS PART_FE,
			  'IBFT' AS SERVICE_TYPE
			FROM SHCLOG_SETT_IBFT
			WHERE (
			        (Respcode = 0 AND Isrev IS NULL)
			        OR Respcode IN (110,112,113,114,115)
			      )
			  AND Fee_Note IS NOT NULL
			  AND (
			        (PCODE2 IS NULL AND Pcode IN ('00','01','30','35','40','41','42','43','48','94','03','20'))
			        OR (PCODE2 IS NOT NULL AND Pcode IN ('00','01','30','35','40','41','42','43','48','94','91','03','20'))
			      )
			GROUP BY
			  MSGTYPE_DETAIL,
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > STR_TO_DATE(:sett_to,'%d/%m/%Y')   THEN STR_TO_DATE(:sett_to,'%d/%m/%Y')
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from, '%d/m/Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y') THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE WHEN DATE(Edit_Date) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y') ELSE DATE(Edit_Date) END
			  END,
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END,
			  RESPCODE,
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,
			  CASE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			      THEN CONCAT(SUBSTRING(LPAD(CAST(PCODE AS CHAR),2,'0'),1,2), PCODE2)
			    ELSE SUBSTRING(LPAD(CAST(PCODE AS CHAR),2,'0'),1,2)
			  END,
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,979500,988500,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,
			  ACQUIRER_RP,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ISSUER_RP ELSE BB_BIN END,
			  CASE
			    WHEN ISSUER_RP IN (220699,602907,605609,:bccard_id,600005,600006,600007) THEN ISSUER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END,
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND Merchant_type_orig IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END,
			  CASE
			    WHEN Msgtype = 430 AND Respcode = 114 THEN 1
			    WHEN Msgtype = 210 AND Respcode IN (112,114) AND Is_part_rev = 430 THEN 1
			    ELSE 0
			  END
				;
			""";

	// -- step 3 -- ISS-BEN
	private static final String SQL_STEP_3_ISS_BEN = """
						-- step 3
						-- ISS-BEN (TiDB)
			INSERT INTO TCKT_SESSION_DOMESTIC(
			    INSERT_DATE, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE, GROUP_TRAN, PCODE, TRAN_TYPE,
			    SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK, DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE,
			    DB_TOTAL_FEE, DB_TOTAL_MONEY, CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			    NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, STEP, FEE_TYPE, SERVICE_TYPE
			)
			SELECT
			    NOW() AS INSERT_DATE,
			    CASE
			        WHEN Respcode = 0 AND SETTLEMENT_DATE <  STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			        WHEN Respcode = 0 AND SETTLEMENT_DATE >  STR_TO_DATE(:sett_to,'%d/%m/%Y')   THEN STR_TO_DATE(:sett_to,'%d/%m/%Y')
			        WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y') THEN SETTLEMENT_DATE
			        ELSE NULL
			    END AS SETT_DATE,
			    CASE
			        WHEN Respcode = 0 THEN NULL
			        ELSE CASE
			               WHEN DATE(Edit_Date) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			               ELSE DATE(Edit_Date)
			             END
			    END AS EDIT_DATE,
			    CASE
			        WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			        WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			        ELSE 704
			    END AS SETTLEMENT_CURRENCY,
			    RESPCODE,
			    CASE
			        WHEN Pcode2 IN (920000) THEN 'QR'
			        WHEN Pcode2 = 890000    THEN 'QRPAY'
			        WHEN Pcode2 = 720000    THEN 'E-Wallet'
			        WHEN Pcode2 = 730000    THEN 'EFT'
			        WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			        WHEN PCODE2 = 930000    THEN 'IBFT'
			        WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT'
			        WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			        WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			        ELSE 'Non IBFT'
			    END AS GROUP_TRAN,
			    PCODE,
			    CASE
			        WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			        WHEN PCode2 = 890000 THEN 'QRC'
			        WHEN PCode2 = 720000 THEN 'CAOT'
			        WHEN PCode2 = 730000 THEN 'EFTC'
			        WHEN PCode2 = 810000 THEN 'CA5'
			        WHEN PCode2 = 820000 THEN 'CA4'
			        WHEN PCode2 = 830000 THEN 'CA2'
			        WHEN PCode2 = 840000 THEN 'SSP_ON'
			        WHEN PCode2 = 850000 THEN 'SSP_OFF'
			        WHEN PCode2 = 860000 THEN 'CA1'
			        WHEN PCode2 = 870000 THEN 'CA3'
			        WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			        WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			        WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'ATM'
			        WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'SMS'
			        WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'INT'
			        WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'MOB'
			        WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT khác'
			        WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			        ELSE 'POS'
			    END AS TRAN_TYPE,
			    'SWITCH' AS SERVICE_CODE,
			    'ISS-BEN' AS GROUP_ROLE,
			    ISSUER_RP AS BANK_ID,
			    BB_BIN AS CORR_BANK_ID,
			    /* WITH_BANK: thay GET_QRC_WITH bằng NOT EXISTS và dùng y hệt trong GROUP BY */
			    CASE
			        WHEN PCode2 = 920000 THEN 764000
			        WHEN Pcode2 IN (720000,730000,890000) THEN
			             CASE
			                WHEN NOT EXISTS (SELECT 1 FROM TGTT_CONFIG t WHERE t.TGTT_ID = BB_BIN)
			                THEN BB_BIN ELSE 0
			             END
			        ELSE 0
			    END AS WITH_BANK,
			    SUM(CASE WHEN Pcode IN ('41','43','48') THEN 0 ELSE 1 END) AS DB_TOTAL_TRAN,
			    SUM(
			        CASE
			            WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			            ELSE CASE
			                   WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT
			                   WHEN ACQ_CURRENCY_CODE = 764 THEN SETTLEMENT_AMOUNT  -- QR_ITMX
			                   ELSE AMOUNT
			                 END
			        END
			    ) AS DB_AMOUNT,
			    SUM(
			        CASE
			            WHEN (CASE WHEN Pcode IN ('41','42','43','48','91') THEN 0 ELSE FEE_IRF_ISS END) < 0
			            THEN -(CASE WHEN Pcode IN ('41','42','43','48','91') THEN 0 ELSE FEE_IRF_ISS END)
			            ELSE 0
			        END
			    ) AS DB_IR_FEE,
			    -SUM(CASE WHEN Pcode IN ('41','43','48') THEN 0 ELSE FEE_SVF_ISS END) AS DB_SV_FEE,
			    0 AS DB_TOTAL_FEE,
			    0 AS DB_TOTAL_MONEY,
			    0 AS CD_TOTAL_TRAN,
			    0 AS CD_AMOUNT,
			    SUM(CASE WHEN FEE_IRF_ISS > 0 THEN FEE_IRF_ISS ELSE 0 END) AS CD_IR_FEE,
			    SUM(CASE WHEN FEE_SVF_ISS < 0 THEN 0 ELSE FEE_SVF_ISS END) AS CD_SV_FEE,
			    0 AS CD_TOTAL_MONEY,
			    0 AS NAPAS_FEE,
			    0 AS ADJ_FEE,
			    0 AS NP_ADJ_FEE,
			    CASE
			        WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			        WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			        ELSE NULL
			    END AS MERCHANT_TYPE,
			    'A-BY_ROLE' AS STEP,
			    CASE
			        WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			        WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			        WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			        WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			        WHEN PCODE2 = 950000 AND ISSUER_FE  = 980471 THEN 'ACH_FEE'
			        WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			        WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			        ELSE 'GDDC_CU'
			    END AS FEE_TYPE,
			    'IBFT' AS SERVICE_TYPE
			FROM SHCLOG_SETT_IBFT
			WHERE
			    ((Respcode = 0 AND Isrev IS NULL) OR Respcode IN (110,112,113,114,115))
			    AND Msgtype = 210
			    AND Fee_note IS NOT NULL
			    AND Pcode IN ('41','42','43','48','91')
			GROUP BY
			    /* SETT_DATE */
			    CASE
			        WHEN Respcode = 0 AND SETTLEMENT_DATE <  STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			        WHEN Respcode = 0 AND SETTLEMENT_DATE >  STR_TO_DATE(:sett_to,'%d/%m/%Y')   THEN STR_TO_DATE(:sett_to,'%d/%m/%Y')
			        WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y') THEN SETTLEMENT_DATE
			        ELSE NULL
			    END,
			    /* EDIT_DATE */
			    CASE
			        WHEN Respcode = 0 THEN NULL
			        ELSE CASE
			               WHEN DATE(Edit_Date) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			               ELSE DATE(Edit_Date)
			             END
			    END,
			    /* SETTLEMENT_CURRENCY */
			    CASE
			        WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			        WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			        ELSE 704
			    END,
			    RESPCODE,
			    /* GROUP_TRAN */
			    CASE
			        WHEN Pcode2 IN (920000) THEN 'QR'
			        WHEN Pcode2 = 890000    THEN 'QRPAY'
			        WHEN Pcode2 = 720000    THEN 'E-Wallet'
			        WHEN Pcode2 = 730000    THEN 'EFT'
			        WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			        WHEN PCODE2 = 930000    THEN 'IBFT'
			        WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT'
			        WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			        WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			        ELSE 'Non IBFT'
			    END,
			    PCODE,
			    /* TRAN_TYPE */
			    CASE
			        WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			        WHEN PCode2 = 890000 THEN 'QRC'
			        WHEN PCode2 = 720000 THEN 'CAOT'
			        WHEN PCode2 = 730000 THEN 'EFTC'
			        WHEN PCode2 = 810000 THEN 'CA5'
			        WHEN PCode2 = 820000 THEN 'CA4'
			        WHEN PCode2 = 830000 THEN 'CA2'
			        WHEN PCode2 = 840000 THEN 'SSP_ON'
			        WHEN PCode2 = 850000 THEN 'SSP_OFF'
			        WHEN PCode2 = 860000 THEN 'CA1'
			        WHEN PCode2 = 870000 THEN 'CA3'
			        WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			        WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			        WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'ATM'
			        WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'SMS'
			        WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'INT'
			        WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST') = 'IST') THEN 'MOB'
			        WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT khác'
			        WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			        ELSE 'POS'
			    END,
			    ISSUER_RP,
			    BB_BIN,
			    /* WITH_BANK: trùng với SELECT */
			    CASE
			        WHEN PCode2 = 920000 THEN 764000
			        WHEN Pcode2 IN (720000,730000,890000) THEN
			             CASE
			                WHEN NOT EXISTS (SELECT 1 FROM TGTT_CONFIG t WHERE t.TGTT_ID = BB_BIN)
			                THEN BB_BIN ELSE 0
			             END
			        ELSE 0
			    END,
			    /* MERCHANT_TYPE */
			    CASE
			        WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			        WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			        ELSE NULL
			    END,
			    /* FEE_TYPE */
			    CASE
			        WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			        WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			        WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			        WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			        WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			        WHEN PCODE2 = 950000 AND ISSUER_FE  = 980471 THEN 'ACH_FEE'
			        WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			        WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			        WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			        WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			        ELSE 'GDDC_CU'
			    END;

						""";

	// -- step 5 -- BEN-ISS
	private static final String SQL_STEP_5_BEN_ISS = """
						-- step 5
			INSERT INTO TCKT_SESSION_DOMESTIC
			(
			  INSERT_DATE, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE, GROUP_TRAN, PCODE, TRAN_TYPE,
			  SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK, DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE,
			  DB_TOTAL_FEE, DB_TOTAL_MONEY, CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, STEP, FEE_TYPE, SERVICE_TYPE
			)
			SELECT
			  NOW() AS INSERT_DATE,

			  CASE
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE <  STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE >  STR_TO_DATE(:sett_to  ,'%d/%m/%Y') THEN STR_TO_DATE(:sett_to  ,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y')
			      THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,

			  CASE
			    WHEN RESPCODE = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(EDIT_DATE) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			           ELSE DATE(EDIT_DATE)
			         END
			  END AS EDIT_DATE,

			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END AS SETTLEMENT_CURRENCY,

			  RESPCODE,

			  CASE
			    WHEN Pcode2 IN (920000) THEN 'QR'
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN Pcode2 = 930000 THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,

			  PCODE,

			  CASE
			    WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			    WHEN Pcode2 = 890000 THEN 'QRC'
			    WHEN Pcode2 = 720000 THEN 'CAOT'
			    WHEN Pcode2 = 730000 THEN 'EFTC'
			    WHEN Pcode2 = 810000 THEN 'CA5'
			    WHEN Pcode2 = 820000 THEN 'CA4'
			    WHEN Pcode2 = 830000 THEN 'CA2'
			    WHEN Pcode2 = 840000 THEN 'SSP_ON'
			    WHEN Pcode2 = 850000 THEN 'SSP_OFF'
			    WHEN Pcode2 = 860000 THEN 'CA1'
			    WHEN Pcode2 = 870000 THEN 'CA3'
			    WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			    WHEN Pcode2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'MOB'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT khác'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,

			  'SWITCH' AS SERVICE_CODE,
			  'BEN-ISS' AS GROUP_ROLE,
			  BB_BIN AS BANK_ID,
			  ISSUER_RP AS CORR_BANK_ID,

			  CASE
			    WHEN Pcode2 = 920000 THEN 764000
			    WHEN ISSUER_RP IN (605609) THEN ISSUER_RP
			    WHEN Pcode2 IN (720000,730000,890000) THEN
			         CASE WHEN EXISTS (SELECT 1 FROM TGTT_CONFIG x WHERE x.TGTT_ID = ISSUER_RP)
			              THEN 0
			              ELSE ISSUER_RP
			         END
			    ELSE 0
			  END AS WITH_BANK,

			  0 AS DB_TOTAL_TRAN,
			  0 AS DB_AMOUNT,

			  SUM(CASE WHEN FEE_IRF_BEN < 0 THEN -FEE_IRF_BEN ELSE 0 END) AS DB_IR_FEE,
			  0 AS DB_SV_FEE,
			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,

			  COUNT(*) AS CD_TOTAL_TRAN,

			  SUM(
			    CASE
			      WHEN RESPCODE IN (112,114) THEN IFNULL(PREAMOUNT,0)
			      ELSE AMOUNT
			    END
			  ) AS CD_AMOUNT,

			  SUM(
			    CASE
			      WHEN Pcode <> '48' AND FEE_IRF_BEN > 0 THEN FEE_IRF_BEN
			      ELSE 0
			    END
			  ) AS CD_IR_FEE,

			  -SUM(FEE_SVF_BEN) AS CD_SV_FEE,

			  0 AS CD_TOTAL_MONEY,
			  0 AS NAPAS_FEE,
			  0 AS ADJ_FEE,
			  0 AS NP_ADJ_FEE,

			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,

			  'A-BY_ROLE' AS STEP,

			  CASE
			    WHEN Pcode2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN Pcode2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN Pcode2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN Pcode2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN Pcode2 = 950000 AND ISSUER_FE  = 980471 THEN 'ACH_FEE'
			    WHEN Pcode2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN Pcode2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,

			  'IBFT' AS SERVICE_TYPE

			FROM SHCLOG_SETT_IBFT
			WHERE
			  (
			    (RESPCODE = 0 AND ISREV IS NULL)
			    OR RESPCODE IN (110,112,113,114,115)
			  )
			  AND MSGTYPE = 210
			  AND FEE_NOTE IS NOT NULL
			  AND PCODE IN ('41','42','43','48','91')
			GROUP BY
			  CASE
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE <  STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE >  STR_TO_DATE(:sett_to  ,'%d/%m/%Y') THEN STR_TO_DATE(:sett_to  ,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y')
			      THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,
			  CASE
			    WHEN RESPCODE = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(EDIT_DATE) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			           ELSE DATE(EDIT_DATE)
			         END
			  END,
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END,
			  RESPCODE,
			  CASE
			    WHEN Pcode2 IN (920000) THEN 'QR'
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN Pcode2 = 930000 THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,
			  PCODE,
			  CASE
			    WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			    WHEN Pcode2 = 890000 THEN 'QRC'
			    WHEN Pcode2 = 720000 THEN 'CAOT'
			    WHEN Pcode2 = 730000 THEN 'EFTC'
			    WHEN Pcode2 = 810000 THEN 'CA5'
			    WHEN Pcode2 = 820000 THEN 'CA4'
			    WHEN Pcode2 = 830000 THEN 'CA2'
			    WHEN Pcode2 = 840000 THEN 'SSP_ON'
			    WHEN Pcode2 = 850000 THEN 'SSP_OFF'
			    WHEN Pcode2 = 860000 THEN 'CA1'
			    WHEN Pcode2 = 870000 THEN 'CA3'
			    WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			    WHEN Pcode2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST') = 'IST') THEN 'MOB'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE = 'C3|72' OR TRAN_CASE = '72|C3') THEN 'IBFT khác'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,
			  BB_BIN,
			  ISSUER_RP,
			  CASE
			    WHEN Pcode2 = 920000 THEN 764000
			    WHEN ISSUER_RP IN (605609) THEN ISSUER_RP
			    WHEN Pcode2 IN (720000,730000,890000) THEN
			         CASE WHEN EXISTS (SELECT 1 FROM TGTT_CONFIG x WHERE x.TGTT_ID = ISSUER_RP)
			              THEN 0
			              ELSE ISSUER_RP
			         END
			    ELSE 0
			  END,
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,
			  CASE
			    WHEN Pcode2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN Pcode2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN Pcode2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN Pcode2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN Pcode2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN Pcode2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN Pcode2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN Pcode2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN Pcode2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN Pcode2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END;
						""";

	// -- Begin: Bat dau do du lieu giao dich dieu chinh tu SHCLOG_SETT_IBFT_ADJUST
	// vao TCKT_SESSION_DOMESTIC

	// -- step 6 -- ISS-ACQ
	private static final String SQL_STEP_6_ADJ_ISS_ACQ = """
									    /* step 6 — TiDB/MySQL version */
			INSERT INTO TCKT_SESSION_DOMESTIC
			(
			  INSERT_DATE, MSGTYPE_DETAIL, SUB_BANK, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE, GROUP_TRAN, PCODE, TRAN_TYPE,
			  SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK, DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE,
			  DB_TOTAL_FEE, DB_TOTAL_MONEY, CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, BC_NP_SUM, BC_CL_ADJ, STEP, FEE_TYPE, PART_FE, SERVICE_TYPE
			)
			SELECT
			  NOW(),
			  MSGTYPE_DETAIL,

			  CASE
			    WHEN ISSUER_RP = 970426 AND SUBSTRING(TRIM(PAN),1,8) = '97046416' THEN 970464
			    ELSE NULL
			  END AS SUB_BANK,

			  CASE
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE <  STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE >  STR_TO_DATE(:sett_to  ,'%d/%m/%Y') THEN STR_TO_DATE(:sett_to  ,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y')
			         THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,

			  CASE
			    WHEN RESPCODE = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(EDIT_DATE) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			           ELSE DATE(EDIT_DATE)
			         END
			  END AS EDIT_DATE,

			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END AS SETTLEMENT_CURRENCY,

			  RESPCODE,

			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode  IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN Pcode2 = 930000 THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE='C3|72' OR TRAN_CASE='72|C3') THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','42','48','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,

			  /* PCODE output */
			  CASE
			    WHEN ISSUER_RP = 602907 THEN IFNULL(PCODE_ORIG, SUBSTRING(LPAD(CAST(PCODE AS CHAR),2,'0'),1,2))
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			      THEN CONCAT(PCODE,PCODE2)
			    ELSE PCODE
			  END AS PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,979500,988500,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE='C3|72' OR TRAN_CASE='72|C3') THEN 'IBFT khác'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,

			  'SWITCH' AS SERVICE_CODE,
			  'ISS-ACQ' AS GROUP_ROLE,

			  ISSUER_RP AS BANK_ID,

			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ACQUIRER_RP ELSE BB_BIN END AS CORR_BANK_ID,

			  CASE
			    WHEN ACQUIRER_RP IN (220699,602907,605609,:bccard_id) THEN ACQUIRER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END AS WITH_BANK,

			  SUM(CASE WHEN Pcode IN ('42','91') THEN 0 ELSE 1 END) AS DB_TOTAL_TRAN,

			  SUM(
			    CASE
			      WHEN Pcode IN ('00','01','40','20') THEN
			        CASE
			          WHEN PCODE='20' AND RESPCODE IN (112,114) THEN -IFNULL(PREAMOUNT,0)
			          WHEN PCODE='20' THEN -AMOUNT
			          WHEN RESPCODE IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE WHEN ACQ_CURRENCY_CODE=418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS DB_AMOUNT,

			  SUM(CASE WHEN FEE_IRF_ISS < 0 THEN -FEE_IRF_ISS ELSE 0 END) AS DB_IR_FEE,

			  -SUM(CASE WHEN Pcode IN ('42','91') THEN 0 ELSE FEE_SVF_ISS END) AS DB_SV_FEE,

			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,

			  0 AS CD_TOTAL_TRAN,

			  SUM(
			    CASE
			      WHEN Pcode IN ('40') THEN
			        CASE
			          WHEN RESPCODE IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE WHEN ACQ_CURRENCY_CODE=418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS CD_AMOUNT,

			  SUM(
			    CASE
			      WHEN FEE_IRF_ISS > 0 AND IFNULL(Pcode2,0) NOT IN (890000,720000) THEN FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS CD_IR_FEE,

			  SUM(CASE WHEN FEE_SVF_ISS < 0 THEN 0 ELSE FEE_SVF_ISS END) AS CD_SV_FEE,

			  SUM(
			    CASE
			      WHEN Pcode IN ('40') THEN
			        CASE
			          WHEN RESPCODE IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE WHEN ACQ_CURRENCY_CODE=418 THEN SETTLEMENT_AMOUNT ELSE AMOUNT END
			        END
			      ELSE 0
			    END
			  ) AS CD_TOTAL_MONEY,

			  0 AS NAPAS_FEE,

			  SUM(
			    CASE
			      WHEN ACQUIRER = 220699 AND MERCHANT_TYPE = 6011 AND Pcode IN ('01','30') THEN FEE_IRF_ACQ
			      WHEN ISSUER   = 220699 AND MERCHANT_TYPE = 6011 AND Pcode IN ('01','30') THEN FEE_IRF_ACQ
			      ELSE 0
			    END
			  ) AS ADJ_FEE,

			  0 AS NP_ADJ_FEE,

			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND MERCHANT_TYPE_ORIG IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,

			  SUM(
			    CASE
			      WHEN ISSUER_RP = 600005 AND MERCHANT_TYPE = 6011 THEN FEE_IRF_ISS
			      WHEN ISSUER_RP = 600005 AND MERCHANT_TYPE = 6012 THEN FEE_IRF_ISS
			      WHEN ISSUER_RP = 600006 AND MERCHANT_TYPE = 6012 THEN FEE_IRF_ISS
			      WHEN ISSUER_RP = 600007 THEN FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS BC_NP_SUM,

			  SUM(CASE WHEN ISSUER_RP IN (600005,600007) THEN FEE_IRF_ISS ELSE 0 END) AS BC_CL_ADJ,

			  'A-BY_ROLE' AS STEP,

			  /* FEE_TYPE */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,

			  CASE
			    WHEN Msgtype = 430 AND RESPCODE = 114 THEN 1
			    WHEN Msgtype = 210 AND RESPCODE IN (112,114) AND IS_PART_REV = 430 THEN 1
			    ELSE 0
			  END AS PART_FE,

			  'IBFT' AS SERVICE_TYPE

			FROM SHCLOG_SETT_IBFT_ADJUST
			WHERE
			  (
			    (RESPCODE = 0 AND ISREV = 0)
			    OR RESPCODE IN (110,112,113,114,115)
			  )
			  AND (
			    (PCODE2 IS NULL     AND PCODE IN ('00','01','30','35','40','41','42','43','48','94','03','20'))
			    OR
			    (PCODE2 IS NOT NULL AND PCODE IN ('00','01','30','35','40','41','42','43','48','94','91','03','20'))
			  )
			GROUP BY
			  MSGTYPE_DETAIL,
			  CASE WHEN ISSUER_RP = 970426 AND SUBSTRING(TRIM(PAN),1,8)='97046416' THEN 970464 ELSE NULL END,
			  CASE
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE <  STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE >  STR_TO_DATE(:sett_to  ,'%d/%m/%Y') THEN STR_TO_DATE(:sett_to  ,'%d/%m/%Y')
			    WHEN RESPCODE = 0 AND SETTLEMENT_DATE BETWEEN STR_TO_DATE(:sett_from,'%d/%m/%Y') AND STR_TO_DATE(:sett_to,'%d/%m/%Y')
			         THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,
			  CASE
			    WHEN RESPCODE = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(EDIT_DATE) < STR_TO_DATE(:sett_from,'%d/%m/%Y') THEN STR_TO_DATE(:sett_from,'%d/%m/%Y')
			           ELSE DATE(EDIT_DATE)
			         END
			  END,
			  CASE WHEN ACQ_CURRENCY_CODE=840 THEN 840 WHEN ACQ_CURRENCY_CODE=418 THEN 418 ELSE 704 END,
			  RESPCODE,
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode  IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN Pcode2 = 930000 THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE='C3|72' OR TRAN_CASE='72|C3') THEN 'IBFT'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','42','48','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,
			  CASE
			    WHEN ISSUER_RP = 602907 THEN IFNULL(PCODE_ORIG, SUBSTRING(LPAD(CAST(PCODE AS CHAR),2,'0'),1,2))
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			      THEN CONCAT(PCODE,PCODE2)
			    ELSE PCODE
			  END,
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,979500,988500,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR COALESCE(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN COALESCE(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE='C3|72' OR TRAN_CASE='72|C3') THEN 'IBFT khác'
			    WHEN COALESCE(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,
			  ISSUER_RP,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ACQUIRER_RP ELSE BB_BIN END,
			  CASE
			    WHEN ACQUIRER_RP IN (220699,602907,605609,:bccard_id) THEN ACQUIRER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END,
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND MERCHANT_TYPE_ORIG IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END,
			  CASE
			    WHEN Msgtype = 430 AND RESPCODE = 114 THEN 1
			    WHEN Msgtype = 210 AND RESPCODE IN (112,114) AND IS_PART_REV = 430 THEN 1
			    ELSE 0
			  END;

									""";

	// -- strep 7 -- ACQ-ISS
	private static final String SQL_STEP_7_ADJ_ACQ_ISS = """
									    /* TODO: Dán câu lệnh INSERT ... SELECT ... đã chuyển hoàn toàn sang TiDB ở đây */
						/* step 8 — TiDB/MySQL version (ACQ-ISS) */
			INSERT INTO TCKT_SESSION_DOMESTIC (
			  INSERT_DATE, MSGTYPE_DETAIL, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE,
			  GROUP_TRAN, PCODE, TRAN_TYPE, SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK,
			  DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE, DB_TOTAL_FEE, DB_TOTAL_MONEY,
			  CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, BC_NP_ADJ, BC_NP_SUM, STEP, FEE_TYPE, PART_FE, SERVICE_TYPE
			)
			WITH params AS (
			  SELECT
			    STR_TO_DATE(:sett_from, '%d/%m/%Y') AS sett_from,
			    STR_TO_DATE(:sett_to,   '%d/%m/%Y') AS sett_to
			)
			SELECT
			  NOW() AS INSERT_DATE,
			  MSGTYPE_DETAIL,

			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < p.sett_from THEN p.sett_from
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > p.sett_to   THEN p.sett_to
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN p.sett_from AND p.sett_to THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE
			      WHEN DATE(Edit_Date) < p.sett_from THEN p.sett_from
			      ELSE DATE(Edit_Date)
			    END
			  END AS EDIT_DATE,

			  /* SETTLEMENT_CURRENCY */
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END AS SETTLEMENT_CURRENCY,

			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,

			  /* PCODE */
			  CASE
			    WHEN Issuer_Rp = 602907 THEN IF(PCODE_ORIG IS NULL, SUBSTRING(LPAD(PCODE,2,'0'),1,2), Pcode_Orig)
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			      THEN CONCAT(PCODE, PCODE2)
			    ELSE PCODE
			  END AS PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,979500,988500,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST')='IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,

			  'SWITCH' AS SERVICE_CODE,
			  'ACQ-ISS' AS GROUP_ROLE,

			  ACQUIRER_RP AS BANK_ID,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ISSUER_RP ELSE BB_BIN END AS CORR_BANK_ID,

			  CASE
			    WHEN ISSUER_RP IN (220699,602907,605609,:bccard_id,600005,600006,600007) THEN ISSUER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END AS WITH_BANK,

			  0 AS DB_TOTAL_TRAN,
			  0 AS DB_AMOUNT,

			  /* DB_IR_FEE */
			  SUM(
			    CASE
			      WHEN ACQUIRER_RP = :bccard_id AND FEE_IRF_ISS > 0 THEN FEE_IRF_ISS
			      WHEN FEE_IRF_ACQ < 0 THEN -FEE_IRF_ACQ
			      ELSE 0
			    END
			  ) AS DB_IR_FEE,

			  0 AS DB_SV_FEE,
			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,

			  /* CD_TOTAL_TRAN */
			  SUM(CASE WHEN Pcode IN ('41','42','43','48','91') THEN 0 ELSE 1 END) AS CD_TOTAL_TRAN,

			  /* CD_AMOUNT */
			  SUM(
			    CASE
			      WHEN Pcode IN ('00','01','20') THEN
			        CASE
			          WHEN PCODE = '20' AND Respcode IN (112,114) THEN -IFNULL(PREAMOUNT,0)
			          WHEN PCODE = '20' THEN -AMOUNT
			          WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			          ELSE CASE
			            WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT
			            ELSE AMOUNT
			          END
			        END
			      ELSE 0
			    END
			  ) AS CD_AMOUNT,

			  /* CD_IR_FEE */
			  SUM(
			    CASE
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type = 6011 THEN -FEE_IRF_ISS
			      WHEN FEE_IRF_ACQ > 0 AND ACQUIRER_RP = :bccard_id AND MERCHANT_TYPE <> 6011 THEN FEE_IRF_ACQ
			      WHEN FEE_IRF_ACQ > 0 AND ACQUIRER_RP = :bccard_id AND MERCHANT_TYPE = 6011 THEN 0
			      WHEN FEE_IRF_ACQ > 0 THEN FEE_IRF_ACQ
			      ELSE 0
			    END
			  ) AS CD_IR_FEE,

			  -SUM(FEE_SVF_ACQ) AS CD_SV_FEE,

			  0 AS CD_TOTAL_MONEY,
			  0 AS NAPAS_FEE,
			  0 AS ADJ_FEE,

			  /* NP_ADJ_FEE */
			  SUM(CASE WHEN FEE_KEY = 'CFC85B5F-787B-437C-823F-79534D3B72BD' THEN FEE_IRF_ACQ ELSE 0 END) AS NP_ADJ_FEE,

			  /* MERCHANT_TYPE (đầu ra) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND Merchant_type_orig IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,

			  /* BC_NP_ADJ */
			  -SUM(
			    CASE
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type = 6011 THEN FEE_IRF_ISS
			      WHEN ACQUIRER_RP = :bccard_id AND FEE_IRF_ISS > 0 AND Merchant_Type <> 6011 THEN FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS BC_NP_ADJ,

			  /* BC_NP_SUM */
			  SUM(
			    CASE
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type = 6011 THEN -FEE_IRF_ISS
			      WHEN Acquirer_Rp = :bccard_id AND Merchant_Type <> 6011 THEN -FEE_IRF_ISS
			      ELSE 0
			    END
			  ) AS BC_NP_SUM,

			  'A-BY_ROLE' AS STEP,

			  /* FEE_TYPE */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,

			  /* PART_FE */
			  CASE
			    WHEN Msgtype = 430 AND Respcode = 114 THEN 1
			    WHEN Msgtype = 210 AND Respcode IN (112,114) AND Is_part_rev = 430 THEN 1
			    ELSE 0
			  END AS PART_FE,

			  'IBFT' AS SERVICE_TYPE
			FROM SHCLOG_SETT_IBFT_ADJUST
			JOIN params p
			WHERE
			  (
			    (Respcode = 0 AND Isrev = 0)
			    OR Respcode IN (110,112,113,114,115)
			  )
			  AND (
			    (PCODE2 IS NULL AND Pcode IN ('00','01','30','35','40','41','42','43','48','94','03','20'))
			    OR
			    (PCODE2 IS NOT NULL AND Pcode IN ('00','01','30','35','40','41','42','43','48','94','91','03','20'))
			  )
			GROUP BY
			  MSGTYPE_DETAIL,

			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < p.sett_from THEN p.sett_from
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > p.sett_to   THEN p.sett_to
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN p.sett_from AND p.sett_to THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE WHEN DATE(Edit_Date) < p.sett_from THEN p.sett_from ELSE DATE(Edit_Date) END
			  END,

			  /* SETTLEMENT_CURRENCY */
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END,

			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,

			  /* PCODE */
			  CASE
			    WHEN Issuer_Rp = 602907 THEN IF(PCODE_ORIG IS NULL, SUBSTRING(LPAD(PCODE,2,'0'),1,2), Pcode_Orig)
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967700,977700,987700,997700,967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200)
			      THEN CONCAT(PCODE, PCODE2)
			    ELSE PCODE
			  END,

			  /* TRAN_TYPE */
			  CASE
			    WHEN PCODE2 IN (750000,967500,977500,987500,997500,760000,967600,977600,987600,997600,770000,967700,977700,987700,997700) THEN 'TRANSIT'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 IN (840000,968400,978400,988400,998400) THEN 'SSP_ON'
			    WHEN PCode2 IN (850000,968500,978500,988500,998500) THEN 'SSP_OFF'
			    WHEN PCode2 IN (780000,967800,977800,987800,997800) THEN 'BP_ON'
			    WHEN PCode2 IN (790000,967900,979500,988500,997900) THEN 'BP_OFF'
			    WHEN PCode2 IN (610000,966100,976100,986100,996100) THEN 'APPLEPAY_ON'
			    WHEN PCode2 IN (620000,966200,976200,986200,996200) THEN 'APPLEPAY_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN PCODE2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST')='IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,

			  ACQUIRER_RP,
			  CASE WHEN ISSUER_RP <> ACQUIRER_RP THEN ISSUER_RP ELSE BB_BIN END,

			  CASE
			    WHEN ISSUER_RP IN (220699,602907,605609,:bccard_id,600005,600006,600007) THEN ISSUER_RP
			    WHEN PCode2 IN (810000,820000,830000,860000,870000) THEN 999999
			    ELSE 0
			  END,

			  /* MERCHANT_TYPE (đầu ra) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN PCODE2 IN (960000,970000,980000,990000,967500,977500,967600,977600,968400,978400,968500,978500,
			                    987500,997500,987600,997600,988400,998400,988500,998500,
			                    967800,977800,987800,997800,967900,977900,987900,997900,
			                    966100,976100,986100,996100,966200,976200,986200,996200) THEN MERCHANT_TYPE_ORIG
			    WHEN Pcode = 0 AND Merchant_type_orig IN (4111,4131,5172,9211,9222,9223,9311,9399,8398,7523,7524,5541,5542) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,

			  /* FEE_TYPE (đầu ra) */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END,

			  /* PART_FE (đầu ra) */
			  CASE
			    WHEN Msgtype = 430 AND Respcode = 114 THEN 1
			    WHEN Msgtype = 210 AND Respcode IN (112,114) AND Is_part_rev = 430 THEN 1
			    ELSE 0
			  END
			;

									""";

	// -- step 8 -- ISS-BEN
	private static final String SQL_STEP_8_ADJ_ISS_BEN = """
									    /* TODO: Dán câu lệnh INSERT ... SELECT ... đã chuyển hoàn toàn sang TiDB ở đây */
						/* ISS-BEN – step 8 (TiDB/MySQL) */
			INSERT INTO TCKT_SESSION_DOMESTIC(
			  INSERT_DATE, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE, GROUP_TRAN, PCODE, TRAN_TYPE,
			  SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK, DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE,
			  DB_TOTAL_FEE, DB_TOTAL_MONEY, CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, STEP, FEE_TYPE, SERVICE_TYPE
			)
			WITH params AS (
			  SELECT
			    STR_TO_DATE(:sett_from, '%d/%m/%Y') AS sett_from,
			    STR_TO_DATE(:sett_to,   '%d/%m/%Y') AS sett_to
			)
			SELECT
			  NOW() AS INSERT_DATE,

			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < p.sett_from THEN p.sett_from
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > p.sett_to   THEN p.sett_to
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN p.sett_from AND p.sett_to THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(Edit_Date) < p.sett_from THEN p.sett_from
			           ELSE DATE(Edit_Date)
			         END
			  END AS EDIT_DATE,

			  /* SETTLEMENT_CURRENCY */
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END AS SETTLEMENT_CURRENCY,

			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 IN (920000) THEN 'QR'
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,

			  PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 = 840000 THEN 'SSP_ON'
			    WHEN PCode2 = 850000 THEN 'SSP_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,

			  /* SERVICE_CODE, GROUP_ROLE */
			  'SWITCH' AS SERVICE_CODE,
			  'ISS-BEN' AS GROUP_ROLE,

			  ISSUER_RP AS BANK_ID,
			  BB_BIN    AS CORR_BANK_ID,

			  /* WITH_BANK */
			  CASE
			    WHEN PCode2 = 920000 THEN 764000
			    WHEN Pcode2 IN (720000,730000,890000) THEN
			    /* GET_QRC_WITH(BB_BIN) */
			           CASE
			              WHEN NOT EXISTS (SELECT 1 FROM TGTT_CONFIG t WHERE t.TGTT_ID = BB_BIN)
			              THEN BB_BIN ELSE 0
			           END
			    ELSE 0
			  END AS WITH_BANK,

			  /* DB_TOTAL_TRAN */
			  SUM(CASE WHEN Pcode IN ('41','43','48') THEN 0 ELSE 1 END) AS DB_TOTAL_TRAN,

			  /* DB_AMOUNT */
			  SUM(
			    CASE
			      WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			      ELSE
			        CASE
			          WHEN ACQ_CURRENCY_CODE = 418 THEN SETTLEMENT_AMOUNT
			          WHEN ACQ_CURRENCY_CODE = 764 THEN SETTLEMENT_AMOUNT   /* QR_ITMX */
			          ELSE AMOUNT
			        END
			    END
			  ) AS DB_AMOUNT,

			  /* DB_IR_FEE */
			  SUM(
			    CASE
			      WHEN (CASE WHEN Pcode IN ('41','42','43','48','91') THEN 0 ELSE FEE_IRF_ISS END) < 0
			        THEN - (CASE WHEN Pcode IN ('41','42','43','48','91') THEN 0 ELSE FEE_IRF_ISS END)
			      ELSE 0
			    END
			  ) AS DB_IR_FEE,

			  /* DB_SV_FEE */
			  -SUM(CASE WHEN Pcode IN ('41','43','48') THEN 0 ELSE FEE_SVF_ISS END) AS DB_SV_FEE,

			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,

			  0 AS CD_TOTAL_TRAN,
			  0 AS CD_AMOUNT,

			  /* CD_IR_FEE, CD_SV_FEE */
			  SUM(CASE WHEN FEE_IRF_ISS > 0 THEN FEE_IRF_ISS ELSE 0 END) AS CD_IR_FEE,
			  SUM(CASE WHEN FEE_SVF_ISS < 0 THEN 0 ELSE FEE_SVF_ISS END)  AS CD_SV_FEE,

			  0 AS CD_TOTAL_MONEY,
			  0 AS NAPAS_FEE,
			  0 AS ADJ_FEE,
			  0 AS NP_ADJ_FEE,

			  /* MERCHANT_TYPE (đầu ra) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,

			  'A-BY_ROLE' AS STEP,

			  /* FEE_TYPE */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE  = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,

			  'IBFT' AS SERVICE_TYPE
			FROM SHCLOG_SETT_IBFT_ADJUST s
			CROSS JOIN params p
			WHERE
			  ((Respcode = 0 AND Isrev = 0) OR Respcode IN (110,112,113,114,115))
			  AND Msgtype = 210
			  AND Pcode IN ('41','42','43','48','91')
			GROUP BY
			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < p.sett_from THEN p.sett_from
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > p.sett_to   THEN p.sett_to
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN p.sett_from AND p.sett_to THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE WHEN DATE(Edit_Date) < p.sett_from THEN p.sett_from ELSE DATE(Edit_Date) END
			  END,

			  /* SETTLEMENT_CURRENCY */
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END,
			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 IN (920000) THEN 'QR'
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,

			  PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 = 840000 THEN 'SSP_ON'
			    WHEN PCode2 = 850000 THEN 'SSP_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91') AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,

			  /* SERVICE_CODE, GROUP_ROLE (đưa vào GROUP BY để safe) */
			  'SWITCH',
			  'ISS-BEN',

			  ISSUER_RP,
			  BB_BIN,

			  /* WITH_BANK expression */
			  CASE
			    WHEN PCode2 = 920000 THEN 764000
			    WHEN Pcode2 IN (720000,730000,890000) THEN
			    -- GET_QRC_WITH(BB_BIN)
			    	CASE
			              WHEN NOT EXISTS (SELECT 1 FROM TGTT_CONFIG t WHERE t.TGTT_ID = BB_BIN)
			              THEN BB_BIN ELSE 0
			        END
			    ELSE 0
			  END,

			  /* MERCHANT_TYPE (đầu ra) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,

			  /* FEE_TYPE (đầu ra) */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE  = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END,

			  /* STEP, SERVICE_CODE, GROUP_ROLE, SERVICE_TYPE constants để safe với ONLY_FULL_GROUP_BY */
			  'A-BY_ROLE',
			  'SWITCH',
			  'ISS-BEN',
			  'IBFT'
			;

									""";

	// -- step 9 -- BEN-ISS
	private static final String SQL_STEP_9_ADJ_BEN_ISS = """
									    /* TODO: Dán câu lệnh INSERT ... SELECT ... đã chuyển hoàn toàn sang TiDB ở đây */
						/* BEN-ISS – step 9 (TiDB/MySQL) */
			INSERT INTO TCKT_SESSION_DOMESTIC(
			  INSERT_DATE, SETT_DATE, EDIT_DATE, SETTLEMENT_CURRENCY, RESPCODE, GROUP_TRAN, PCODE, TRAN_TYPE,
			  SERVICE_CODE, GROUP_ROLE, BANK_ID, CORR_BANK_ID, WITH_BANK, DB_TOTAL_TRAN, DB_AMOUNT, DB_IR_FEE, DB_SV_FEE,
			  DB_TOTAL_FEE, DB_TOTAL_MONEY, CD_TOTAL_TRAN, CD_AMOUNT, CD_IR_FEE, CD_SV_FEE, CD_TOTAL_MONEY,
			  NAPAS_FEE, ADJ_FEE, NP_ADJ_FEE, MERCHANT_TYPE, STEP, FEE_TYPE, SERVICE_TYPE
			)
			WITH params AS (
			  SELECT
			    STR_TO_DATE(:sett_from, '%d/%m/%Y') AS sett_from,
			    STR_TO_DATE(:sett_to,   '%d/%m/%Y') AS sett_to
			)
			SELECT
			  NOW() AS INSERT_DATE,

			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < p.sett_from THEN p.sett_from
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > p.sett_to   THEN p.sett_to
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN p.sett_from AND p.sett_to THEN SETTLEMENT_DATE
			    ELSE NULL
			  END AS SETT_DATE,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE
			           WHEN DATE(Edit_Date) < p.sett_from THEN p.sett_from
			           ELSE DATE(Edit_Date)
			         END
			  END AS EDIT_DATE,

			  /* SETTLEMENT_CURRENCY */
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END AS SETTLEMENT_CURRENCY,

			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 IN (920000) THEN 'QR'
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END AS GROUP_TRAN,

			  PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 = 840000 THEN 'SSP_ON'
			    WHEN PCode2 = 850000 THEN 'SSP_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END AS TRAN_TYPE,

			  'SWITCH'  AS SERVICE_CODE,
			  'BEN-ISS' AS GROUP_ROLE,

			  BB_BIN    AS BANK_ID,
			  ISSUER_RP AS CORR_BANK_ID,

			  /* WITH_BANK (thay GET_QRC_WITH(Issuer_Rp) bằng CASE + EXISTS) */
			  CASE
			    WHEN PCode2 = 920000 THEN 764000
			    WHEN ISSUER_RP IN (605609) THEN ISSUER_RP
			    WHEN Pcode2 IN (720000,730000,890000) THEN
			         CASE
			           WHEN EXISTS (
			                  SELECT 1
			                  FROM TGTT_CONFIG t
			                  WHERE t.TGTT_ID = CAST(ISSUER_RP AS CHAR)   -- có trong TGTT_CONFIG -> trả 0
			                )
			             THEN 0
			           ELSE ISSUER_RP                                   -- không có -> trả Issuer_Rp
			         END
			    ELSE 0
			  END AS WITH_BANK,

			  0 AS DB_TOTAL_TRAN,
			  0 AS DB_AMOUNT,

			  /* DB_IR_FEE */
			  SUM(CASE WHEN FEE_IRF_BEN < 0 THEN -FEE_IRF_BEN ELSE 0 END) AS DB_IR_FEE,

			  0 AS DB_SV_FEE,
			  0 AS DB_TOTAL_FEE,
			  0 AS DB_TOTAL_MONEY,

			  COUNT(*) AS CD_TOTAL_TRAN,

			  /* CD_AMOUNT */
			  SUM(
			    CASE
			      WHEN Respcode IN (112,114) THEN IFNULL(PREAMOUNT,0)
			      ELSE AMOUNT
			    END
			  ) AS CD_AMOUNT,

			  /* CD_IR_FEE */
			  SUM(
			    CASE
			      WHEN (CASE WHEN Pcode = '48' THEN 0 ELSE (CASE WHEN FEE_IRF_BEN > 0 THEN FEE_IRF_BEN ELSE 0 END) END) > 0
			        THEN (CASE WHEN Pcode = '48' THEN 0 ELSE (CASE WHEN FEE_IRF_BEN > 0 THEN FEE_IRF_BEN ELSE 0 END) END)
			      ELSE 0
			    END
			  ) AS CD_IR_FEE,

			  -SUM(FEE_SVF_BEN) AS CD_SV_FEE,

			  0 AS CD_TOTAL_MONEY,
			  0 AS NAPAS_FEE,
			  0 AS ADJ_FEE,
			  0 AS NP_ADJ_FEE,

			  /* MERCHANT_TYPE (đầu ra) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END AS MERCHANT_TYPE,

			  'A-BY_ROLE' AS STEP,

			  /* FEE_TYPE */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END AS FEE_TYPE,

			  'IBFT' AS SERVICE_TYPE

			FROM SHCLOG_SETT_IBFT_ADJUST s
			CROSS JOIN params p
			WHERE
			  (
			    (Respcode = 0 AND Isrev = 0)
			    OR Respcode IN (110,112,113,114,115)
			  )
			  AND Msgtype = 210
			  AND Pcode IN ('41','42','43','48','91')
			GROUP BY
			  /* SETT_DATE */
			  CASE
			    WHEN Respcode = 0 AND SETTLEMENT_DATE < p.sett_from THEN p.sett_from
			    WHEN Respcode = 0 AND SETTLEMENT_DATE > p.sett_to   THEN p.sett_to
			    WHEN Respcode = 0 AND SETTLEMENT_DATE BETWEEN p.sett_from AND p.sett_to THEN SETTLEMENT_DATE
			    ELSE NULL
			  END,

			  /* EDIT_DATE */
			  CASE
			    WHEN Respcode = 0 THEN NULL
			    ELSE CASE WHEN DATE(Edit_Date) < p.sett_from THEN p.sett_from ELSE DATE(Edit_Date) END
			  END,

			  /* SETTLEMENT_CURRENCY */
			  CASE
			    WHEN ACQ_CURRENCY_CODE = 840 THEN 840
			    WHEN ACQ_CURRENCY_CODE = 418 THEN 418
			    ELSE 704
			  END,
			  RESPCODE,

			  /* GROUP_TRAN */
			  CASE
			    WHEN Pcode2 IN (920000) THEN 'QR'
			    WHEN Pcode2 = 890000 THEN 'QRPAY'
			    WHEN Pcode2 = 720000 THEN 'E-Wallet'
			    WHEN Pcode2 = 730000 THEN 'EFT'
			    WHEN Pcode IN ('43') AND Pcode2 IS NULL THEN 'CBFT'
			    WHEN PCODE2 = 930000 THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT'
			    WHEN Pcode2 IN (810000,820000,830000,860000,870000) THEN 'UTMQT'
			    ELSE 'Non IBFT'
			  END,

			  PCODE,

			  /* TRAN_TYPE */
			  CASE
			    WHEN Pcode2 = 920000 THEN 'QR_ITMX'
			    WHEN PCode2 = 890000 THEN 'QRC'
			    WHEN PCode2 = 720000 THEN 'CAOT'
			    WHEN PCode2 = 730000 THEN 'EFTC'
			    WHEN PCode2 = 810000 THEN 'CA5'
			    WHEN PCode2 = 820000 THEN 'CA4'
			    WHEN PCode2 = 830000 THEN 'CA2'
			    WHEN PCode2 = 840000 THEN 'SSP_ON'
			    WHEN PCode2 = 850000 THEN 'SSP_OFF'
			    WHEN PCode2 = 860000 THEN 'CA1'
			    WHEN PCode2 = 870000 THEN 'CA3'
			    WHEN Pcode2 = 930000 THEN 'QR_IBFT'
			    WHEN PCODE2 = 950000 THEN 'Mobile IBFT'
			    WHEN merchant_type = 6011 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'ATM'
			    WHEN merchant_type = 6013 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'SMS'
			    WHEN merchant_type = 6014 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'INT'
			    WHEN merchant_type = 6015 AND Pcode NOT IN ('41','42','48','91')
			         AND (Pcode2 IS NULL OR IFNULL(FROM_SYS,'IST')='IST') THEN 'MOB'
			    WHEN IFNULL(FROM_SYS,'IST') = 'IST|IBT' AND (TRAN_CASE IN ('C3|72','72|C3')) THEN 'IBFT khác'
			    WHEN IFNULL(FROM_SYS,'IST') IN ('IST','IBT') AND Pcode IN ('41','48','42','91') THEN 'IBFT khác'
			    ELSE 'POS'
			  END,

			  /* GROUP_ROLE, SERVICE_CODE (đưa literal vào GROUP BY để an toàn với ONLY_FULL_GROUP_BY) */
			  'BEN-ISS',
			  'SWITCH',

			  BB_BIN,
			  ISSUER_RP,

			  /* WITH_BANK */
			  CASE
			    WHEN PCode2 = 920000 THEN 764000
			    WHEN ISSUER_RP IN (605609) THEN ISSUER_RP
			    WHEN Pcode2 IN (720000,730000,890000) THEN
			         CASE
			           WHEN EXISTS (
			                  SELECT 1
			                  FROM TGTT_CONFIG t
			                  WHERE t.TGTT_ID = CAST(ISSUER_RP AS CHAR)
			                )
			             THEN 0
			           ELSE ISSUER_RP
			         END
			    ELSE 0
			  END,

			  /* MERCHANT_TYPE (đầu ra) */
			  CASE
			    WHEN Pcode IN ('41','42','48','91') THEN MERCHANT_TYPE
			    WHEN Pcode2 IN (960000,970000,968400,978400,968500,978500,967500,977500,967600,977600) THEN MERCHANT_TYPE_ORIG
			    ELSE NULL
			  END,

			  /* FEE_TYPE (đầu ra) */
			  CASE
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 130012 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 930000 AND ISSUER_FE = 971100 THEN 'QR_IBFT_FEE'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 950000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 950000 AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE = 130001 THEN 'COVID_FEE'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130002,130003) THEN 'AMOUNT_1000K'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 910000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130004,130008) THEN 'TIER_LEVEL_1'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130005,130009) THEN 'TIER_LEVEL_2'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130006,130010) THEN 'TIER_LEVEL_3'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130007,130011) THEN 'TIER_LEVEL_4'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130013,130014) THEN 'TIER_LEVEL_5'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130015,130018) THEN 'TIER_LEVEL_6'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130016,130019) THEN 'TIER_LEVEL_7'
			    WHEN PCODE2 = 930000 AND ISSUER_FE IN (130017,130020) THEN 'TIER_LEVEL_8'
			    WHEN PCODE2 IN (910000,930000,950000) AND ISSUER_FE = 980471 THEN 'ACH_FEE'
			    ELSE 'GDDC_CU'
			  END,

			  /* STEP, SERVICE_TYPE hằng số để an toàn với ONLY_FULL_GROUP_BY */
			  'A-BY_ROLE',
			  'IBFT'
			;
									""";

	// -- step 10
	private static final String SQL_STEP_10 = """
			   UPDATE TCKT_SESSION_DOMESTIC
			SET
			  DB_IR_FEE   = 0,
			  DB_SV_FEE   = 0,
			  DB_TOTAL_FEE= 0,
			  CD_IR_FEE   = 0,
			  CD_SV_FEE   = 0,
			  ADJ_FEE     = 0,
			  BC_NP_ADJ   = 0,
			  BC_NP_SUM   = 0
			WHERE
			  RESPCODE IN (112,114)
			  AND SERVICE_TYPE = 'IBFT'
			  -- Hoàn phí giao dịch hoàn trả một phần của NSPK, BC Card
			  AND BANK_ID  NOT IN (600005, :bccard_id)
			  AND WITH_BANK NOT IN (600005, :bccard_id)
			  AND INSERT_DATE > CURDATE();
						""";
	// -- step 11
	private static final String SQL_STEP_11 = """
					    /* step 11 (TiDB/MySQL) */
			UPDATE TCKT_SESSION_DOMESTIC
			SET
			    DB_TOTAL_FEE = DB_IR_FEE + DB_SV_FEE + CD_SV_FEE
			WHERE
			    SERVICE_TYPE = 'IBFT'
			    AND INSERT_DATE > CURDATE();
									""";
	// -- step 12
	private static final String SQL_STEP_12 = """
					   UPDATE TCKT_SESSION_DOMESTIC
			SET
			    DB_TOTAL_MONEY = DB_TOTAL_FEE + DB_AMOUNT
			WHERE
			    SERVICE_TYPE = 'IBFT'
			    AND INSERT_DATE > CURDATE();
									""";
	// -- step 13
	private static final String SQL_STEP_13 = """
					    UPDATE TCKT_SESSION_DOMESTIC
			SET
			    CD_TOTAL_MONEY = CD_AMOUNT + CD_IR_FEE
			WHERE
			    SERVICE_TYPE = 'IBFT'
			    AND INSERT_DATE > CURDATE();
									""";
	// -- step 14
	private static final String SQL_STEP_14 = """
					   UPDATE TCKT_SESSION_DOMESTIC
			SET
			    NAPAS_FEE = CASE
			                   WHEN ADJ_FEE <> 0
			                        THEN DB_TOTAL_FEE - CD_IR_FEE - ADJ_FEE
			                   ELSE DB_SV_FEE + CD_SV_FEE - NP_ADJ_FEE
			                END
			WHERE
			    SERVICE_TYPE = 'IBFT'
			    AND INSERT_DATE > CURDATE();
									""";
	// -- step 15
	private static final String SQL_STEP_15 = """
			/* step 15 (TiDB/MySQL) */
			UPDATE TCKT_SESSION_DOMESTIC
			SET
			  DB_TOTAL_TRAN   = -DB_TOTAL_TRAN,
			  DB_AMOUNT       = -DB_AMOUNT,
			  DB_IR_FEE       = -DB_IR_FEE,
			  DB_SV_FEE       = -DB_SV_FEE,
			  DB_TOTAL_FEE    = -DB_TOTAL_FEE,
			  DB_TOTAL_MONEY  = -DB_TOTAL_MONEY,
			  CD_TOTAL_TRAN   = -CD_TOTAL_TRAN,
			  BC_CL_ADJ       = -BC_CL_ADJ,
			  CD_AMOUNT       = -CD_AMOUNT,
			  CD_IR_FEE       = -CD_IR_FEE,
			  CD_SV_FEE       = -CD_SV_FEE,
			  CD_TOTAL_MONEY  = -CD_TOTAL_MONEY,
			  NAPAS_FEE       = -NAPAS_FEE,
			  BC_NP_ADJ       = -BC_NP_ADJ,
			  BC_NP_SUM       = -BC_NP_SUM
			WHERE
			  RESPCODE IN (112,113,114,115)
			  AND SERVICE_TYPE = 'IBFT'
			  AND INSERT_DATE > CURDATE();
						    """;

	// step 16
	private static final String SQL_STEP_16 = """
						    /* TODO: Dán câu lệnh UPDATE/INSERT/DELETE đã chuyển hoàn toàn sang TiDB ở đây */
						    /* step 16 (TiDB/MySQL) */
			UPDATE TCKT_SESSION_DOMESTIC
			SET
			  DEBIT = CASE
			            WHEN BANK_ID = :bccard_id AND SETTLEMENT_CURRENCY = 704 THEN
			              CASE
			                WHEN DB_AMOUNT > CD_AMOUNT THEN DB_AMOUNT - CD_AMOUNT
			                ELSE 0
			              END
			            WHEN BANK_ID IN (602907,605609,600005,600006,600007,980471,971100,971111) THEN
			              CASE
			                WHEN DB_AMOUNT > CD_AMOUNT THEN DB_AMOUNT - CD_AMOUNT
			                ELSE 0
			              END
			            ELSE
			              CASE
			                WHEN DB_TOTAL_MONEY > CD_TOTAL_MONEY THEN DB_TOTAL_MONEY - CD_TOTAL_MONEY
			                ELSE 0
			              END
			          END,
			  CREDIT = CASE
			            WHEN BANK_ID = :bccard_id AND SETTLEMENT_CURRENCY = 704 AND TRAN_TYPE = 'POS' THEN
			              CASE
			                WHEN CD_AMOUNT > DB_AMOUNT THEN CD_AMOUNT - DB_AMOUNT
			                ELSE 0
			              END
			            WHEN BANK_ID IN (602907,605609,600005,600006,600007,980471,971100,971111) THEN
			              CASE
			                WHEN CD_AMOUNT > DB_AMOUNT THEN CD_AMOUNT - DB_AMOUNT
			                ELSE 0
			              END
			            ELSE
			              CASE
			                WHEN CD_TOTAL_MONEY > DB_TOTAL_MONEY THEN CD_TOTAL_MONEY - DB_TOTAL_MONEY
			                ELSE 0
			              END
			          END
			WHERE
			  SERVICE_TYPE = 'IBFT'
			  AND INSERT_DATE > CURDATE();
			

						""";

	// --step 15
//	private static final String SQL_STEP_15 = """
//			    /* TODO: Dán câu lệnh UPDATE/INSERT/DELETE đã chuyển hoàn toàn sang TiDB ở đây */
//			""";

	@Transactional
	public void run(String fromDate_ddMMyyyy, String toDate_ddMMyyyy, String user) {
		MapSqlParameterSource p = new MapSqlParameterSource().addValue("sett_From", fromDate_ddMMyyyy)
				.addValue("sett_from", fromDate_ddMMyyyy).addValue("fromDate", fromDate_ddMMyyyy)
				.addValue("sett_To", toDate_ddMMyyyy).addValue("sett_to", toDate_ddMMyyyy)
				.addValue("toDate", toDate_ddMMyyyy).addValue("user", user).addValue("bccard_id", bankcardid);

		// Đọc CITAD_SETT_DATE
		try {
			java.sql.Date last = jdbc.queryForObject(
					"SELECT STR_TO_DATE(PARA_VALUE,'%d/%m/%Y') FROM NAPAS_PARA WHERE PARA_NAME='CITAD_SETT_DATE'", p,
					java.sql.Date.class);
			p.addValue("sLastSettDate", last);
		} catch (DataAccessException ex) {
			log.warn("Không đọc được CITAD_SETT_DATE: {}", ex.getMessage());
			p.addValue("lastSettDate", new java.sql.Date(System.currentTimeMillis()));
		}

		// 1) Cleanup backup > 15 ngày
		exec("CLEANUP_BACKUP_15D", SQL_CLEANUP_BACKUP_OLD, p);

		// 2) Backup dữ liệu phiên theo khoảng ngày + user
		exec("BACKUP_SESSION", SQL_BACKUP_SESSION, p);

		// 3) Xoá dữ liệu phiên cũ trong TCKT_SESSION_DOMESTIC (IBFT)
		exec("DELETE_OLD_SESSION", SQL_DELETE_OLD_SESSION, p);

		// 4) ĐỔ DỮ LIỆU TỪ SHCLOG_SETT_IBFT (thành công)
		exec("STEP 1 - ISS-ACQ", SQL_STEP_1_ISS_ACQ, p);
		exec("STEP 2 - ACQ-ISS", SQL_STEP_2_ACQ_ISS, p);
		exec("STEP 3 - ISS-BEN", SQL_STEP_3_ISS_BEN, p);
		exec("STEP 5 - BEN-ISS", SQL_STEP_5_BEN_ISS, p);

		// 6) ĐIỀU CHỈNH TỪ SHCLOG_SETT_IBFT_ADJUST
		exec("STEP 6 - ADJ ISS-ACQ", SQL_STEP_6_ADJ_ISS_ACQ, p);
		exec("STEP 7 - ADJ ISS-ACQ", SQL_STEP_7_ADJ_ACQ_ISS, p);
		exec("STEP 8 - ADJ ACQ-ISS", SQL_STEP_8_ADJ_ISS_BEN, p);
		exec("STEP 9 - ADJ ISS-ACQ", SQL_STEP_9_ADJ_BEN_ISS, p);
		exec("STEP 10 - ADJ ISS-BEN", SQL_STEP_10, p);
		exec("STEP 11 - ADJ ISS-BEN", SQL_STEP_11, p);
		exec("STEP 12 - ADJ ISS-BEN", SQL_STEP_12, p);
		exec("STEP 13 - ADJ ISS-BEN", SQL_STEP_13, p);
		exec("STEP 14 - ADJ ISS-BEN", SQL_STEP_14, p);
		exec("STEP 15 - ADJ ISS-BEN", SQL_STEP_15, p);
		exec("STEP 16 - ADJ BEN-ISS", SQL_STEP_16, p);

	}

	private void exec(String tag, String sql, MapSqlParameterSource p) {
		String trimmed = sql == null ? "" : sql.trim();
		if (trimmed.isEmpty()) {
			log.info("{}: SKIPPED (chưa thay SQL TiDB)", tag);
			return;
		}
		log.info("sql tag: {}", SqlLogUtils.renderSql(sql, p.getValues()));
		int rows = jdbc.update(sql, p);
		log.info("{}: {} row(s)", tag, rows);
	}
}
